#!/usr/bin/env bash
set -euo pipefail

# sync-kilo-prompts.sh
# Generate Kilo-compatible prompts from ops-template system
# Usage:
#   PROJECT_NAME=hakim-platform-kilo ./scripts/sync-kilo-prompts.sh
#   PROJECT_OPS_DIR=/path/to/project ./scripts/sync-kilo-prompts.sh

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
KILO_REGISTRY="$ROOT_DIR/registry/kilo-projects.yaml"

PROJECT_NAME=${PROJECT_NAME:-}
PROJECT_OPS_DIR=${PROJECT_OPS_DIR:-}

# Find project configuration from registry if not provided
if [[ -z "$PROJECT_OPS_DIR" && -n "$PROJECT_NAME" ]]; then
  if ! command -v yq >/dev/null 2>&1; then
    echo "ERROR: PROJECT_OPS_DIR not set and yq not available to read registry." >&2
    exit 1
  fi

  # Find project in registry
  PROJECT_OPS_DIR=$(yq -r ".kilo_projects[] | select(.name == \"$PROJECT_NAME\") | .path" "$KILO_REGISTRY" 2>/dev/null | envsubst)
  USE_KILO_PROMPTS=$(yq -r ".kilo_projects[] | select(.name == \"$PROJECT_NAME\") | .use_kilo_prompts // \"false\"" "$KILO_REGISTRY" 2>/dev/null)

  if [[ -z "$PROJECT_OPS_DIR" || "$USE_KILO_PROMPTS" != "true" ]]; then
    echo "Project $PROJECT_NAME not found in Kilo registry or not configured for Kilo prompts" >&2
    exit 1
  fi
fi

if [[ -z "$PROJECT_OPS_DIR" ]]; then
  echo "Set PROJECT_OPS_DIR or PROJECT_NAME to identify the target project." >&2
  exit 1
fi

# Create Kilo directories
KILO_DIR="$PROJECT_OPS_DIR/kilo/prompts"
MERGED_DIR="$KILO_DIR/merged"
TRIGGERS_DIR="$KILO_DIR/triggers"
mkdir -p "$MERGED_DIR" "$TRIGGERS_DIR"

# Role mapping for Kilo (ops-template roles → Kilo-friendly names)
# Using a simple approach to avoid associative array issues
KILO_ROLES_ARCHITECT="Architect"
KILO_ROLES_DEV="Dev"
KILO_ROLES_QA="QA"
KILO_ROLES_TEAM_LEAD="TeamLead"
KILO_ROLES_RELEASE_MANAGER="ReleaseManager"
KILO_ROLES_SRE="SRE"

# Determine which roles to generate based on project type
ROLES_TO_GENERATE=("architect" "dev" "qa" "team_lead" "release_manager" "sre")

# Check if this is the main ops-template project (gets Ops-Agent)
if [[ "$(basename "$PROJECT_OPS_DIR")" == "ops-template" ]]; then
  ROLES_TO_GENERATE+=("ops_agent")
  KILO_ROLES_OPS_AGENT="OpsAgent"
fi

echo "Generating Kilo prompts for project: $(basename "$PROJECT_OPS_DIR")"
echo "Output directory: $KILO_DIR"

for role in "${ROLES_TO_GENERATE[@]}"; do
  # Get the kilo name for this role
  case "$role" in
    "architect") kilo_name="$KILO_ROLES_ARCHITECT" ;;
    "dev") kilo_name="$KILO_ROLES_DEV" ;;
    "qa") kilo_name="$KILO_ROLES_QA" ;;
    "team_lead") kilo_name="$KILO_ROLES_TEAM_LEAD" ;;
    "release_manager") kilo_name="$KILO_ROLES_RELEASE_MANAGER" ;;
    "sre") kilo_name="$KILO_ROLES_SRE" ;;
    "ops_agent") kilo_name="$KILO_ROLES_OPS_AGENT" ;;
    *) kilo_name="$role" ;;
  esac

  output_file="$MERGED_DIR/${kilo_name}.kilo.md"

  echo "  Generating: $role → $kilo_name"

  # Use existing merge script with Kilo adaptations
  ROLE="$role" SEAT="$role.default" PROJECT_OPS_DIR="$PROJECT_OPS_DIR" \
    "$ROOT_DIR/scripts/merge-role-prompt.sh" > "$output_file"

  # Adapt for Kilo platform
  # Update trigger commands for Kilo
  sed -i.bak 's|/{Role}|/'"$role"'|g' "$output_file"
  sed -i.bak 's|work/{role}|kilo/work/'"$role"'|g' "$output_file"
  sed -i.bak 's|\.copilot/|.kilo/|g' "$output_file"
  sed -i.bak 's|GitHub Issues|Kilo Tasks|g' "$output_file"

  # Create trigger file for easy loading
  cat > "$TRIGGERS_DIR/${role}.md" << EOF
# $kilo_name Agent - Load with: /$role

EOF
  cat "$output_file" >> "$TRIGGERS_DIR/${role}.md"

  # Clean up backup file
  [[ -f "$output_file.bak" ]] && rm "$output_file.bak"
done

echo "✓ Generated $(echo "${ROLES_TO_GENERATE[@]}" | wc -w) Kilo prompts in: $KILO_DIR"
echo ""
echo "Usage:"
for role in "${ROLES_TO_GENERATE[@]}"; do
  # Get the kilo name for this role
  case "$role" in
    "architect") kilo_name="$KILO_ROLES_ARCHITECT" ;;
    "dev") kilo_name="$KILO_ROLES_DEV" ;;
    "qa") kilo_name="$KILO_ROLES_QA" ;;
    "team_lead") kilo_name="$KILO_ROLES_TEAM_LEAD" ;;
    "release_manager") kilo_name="$KILO_ROLES_RELEASE_MANAGER" ;;
    "sre") kilo_name="$KILO_ROLES_SRE" ;;
    "ops_agent") kilo_name="$KILO_ROLES_OPS_AGENT" ;;
    *) kilo_name="$role" ;;
  esac

  echo "  /$role    → Load $kilo_name agent"
done